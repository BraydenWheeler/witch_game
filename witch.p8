pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	state = 1
	iplayer()
	itrees()
	ienemy()
	ianimate()
end


function _update()
	uplayer()
	generate_world()
	animate_trees()
	uenemy()
end


function _draw()
	cls()
	map()
	dplayer()
	dtrees()
	denemy()
end
-->8
-- player --
function iplayer()
	player = {
	x=63,
	y=63,
	speed=2,
	f=false,
	s=17
	}
	
end


function uplayer()
	move(player)
end


function dplayer()
	spr(player.s,player.x,player.y,1,1,player.f)
end
-->8
-- move --
function move(o)
	local lx = o.x
	local ly = o.y
	
	-- button commands --
	if btn(➡️) then
		o.x += o.speed
		o.f = false
		animate_player()
	end
	
	if btn(⬅️) then
		o.x -= o.speed
		o.f = true
		animate_player()
	end
	
	if btn(⬆️) then
		o.y -= o.speed
		animate_player()
	end
	
	if btn(⬇️) then
		o.y += o.speed
		animate_player()
	end
	
	if collide(o) then
		o.x = lx
		o.y = ly
	end
	
end


function collide(o)
	local x1 = o.x/8
	local y1 = o.y/8
	local x2 = (o.x+7)/8
	local y2 = (o.y+7)/8
	
	local a = fget(mget(x1,y1), 0)
	local b = fget(mget(x1,y2), 0)
	local c = fget(mget(x2,y2), 0)
	local d = fget(mget(x2,y1), 0)
	
	-- if out of bounds --
	if (x1<0) or (x1>15) or (y1<0) or (y2>16) then
		return true
	end
		
	-- if collides
	if a or b or c or d then
		return true
	end
	
	-- if hitting tree
	for t in all(trees) do
		local tx1 = t.x/8
		local ty1 = t.y/8
		local tx2 = (t.x+7)/8
		local ty2 = (t.y+7)/8
		
		if ((x1>=tx1) and (x1<=tx2)) or ((x2>=tx1) and (x2<=tx2)) then
			if ((y1>=ty1) and (y1<=ty2)) or ((y2>=ty1) and (y2<=ty2)) then
				t.active = true
				return true
			end
		end
		
	end
		
	return false
end

-->8
-- level generate --
function generate_world()
	local fload = true
	for t in all(trees) do
		if t.s != 14 then
			fload = false
		end
	end
	
	if fload then
		if state == 1 then
	 	level1()
		end
		
		if state == 3 then
			level2()
		end
		
		if state == 5 then
			level3()
		end
		
		-- check if level clear
		if check_clear() then
			state += 1
			player.x = 63
			player.y = 63
		end
	end
end

function check_clear()
	for t in all(trees) do
		if t.active == false then
			return false
		end
	end
	return true
end


function level1()
	mset(0,0,40)
	mset(1,0,41)
	mset(0,1,56)
	mset(1,1,57)
	create_tree(60,20)
	create_enemy(20,20)
	state = 2
end

function level2()
	trees = {}
	enemy = {}
	mset(0,0,1)
	mset(0,1,1)
	mset(1,0,1)
	mset(1,1,1)
	create_tree(100,100)
	create_tree(10,10)
	state = 4
end

function level3()
	trees = {}
	create_tree(10,100)
	create_enemy(100,10)
	state = 6
end
-->8
-- trees --
function itrees()
	trees={}
end


function create_tree(a,b)
	add(trees,{x=a,y=b,active=false,s=2})
end


function dtrees()
	for t in all(trees) do
	
		if t.active then
			
			spr(t.s,t.x,t.y)
		else
			spr(t.s,t.x,t.y)
		end
	end
end


-->8
-- animations --
function ianimate()
	a = {
	stimer=0,
	ani_speed=10
	}
end

function animate_player()

	if a.stimer < a.ani_speed then
		a.stimer += 1
	else
	
		if player.s < 19 then
			player.s += 1
		else
			player.s = 17
		end
	a.stimer = 0
		
	end
end

function animate_trees()
	-- todo  too fast! --
	if a.stimer < a.ani_speed then
		a.stimer += 1
	else
		for t in all(trees) do
			if t.active then
				if t.s < 14 then
					t.s += 1
				end
			else
				t.s = 2
			end
		end
	end
end
-->8
-- enemies --
function ienemy()
	enemy = {}
end

function create_enemy(a,b)
	add(enemy,{x=a,y=b,s=49})
end

function uenemy()
	
	for e in all(enemy) do
		local lx = e.x
		local ly = e.y
	-- choose rnd direction
		local dir = flr(rnd(4))
			
		if (dir == 0) then
			e.x += 3
		end
			
		if (dir == 1) then
			e.x -= 3
		end
			
		if (dir == 2) then
			e.y += 3
		end
			
		if (dir == 3) then
			e.y -= 3
		end
		
		if collide(e) then
			e.x = lx
			e.y = ly
		end
			
	end
end

function denemy()
	for e in all(enemy) do
		spr(e.s,e.x,e.y)
	end
end
__gfx__
00000000333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
0000000033333333bb3bbb33b83bbb33b83bb933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933a83aa933
0070070033333333bbbbbbb3bbbbbbb39bb99b939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a939aa99a93
0007700033333333bbbbbbbbbbbb8bb899bb8bb899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa899aa8aa8
0007700033333333bbbbb4bbbbbb84bbbb9b84bbaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aaaa9a84aa
00700700333333333bbb43333b8843333b8843333a8843333a8843333a8843333a8843333a8843333a8843333a8843333a8843333a8843333a8843333a884333
00000000333333333344433333444333334443333344433333444333334443333344433333444333334443333344433333444333334443333344433333444333
00000000333333333344433333444333334443333344433333444333334443333344433333444333334443333344433333444333334443333344433333444333
00000000022000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002200002222000022220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022220000222200002222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800888888008888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000088ffff8088ffff8088ffff80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000088ffff0088ffff0088ffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000801110008011100080111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002020000220200000202200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022000000000000000000000000000000000000000000000000000003333333333333333000000000000000000000000000000000000000000000000
00000000002200000000000000000000000000000000000000000000000000009393999399933333000000000000000000000000000000000000000000000000
00000000022220000000000000000000000000000000000000000000000000009993393339333333000000000000000000000000000000000000000000000000
000000000eeeeee00000000000000000000000000000000000000000000000009393393339333333000000000000000000000000000000000000000000000000
00000000eeffffe00000000000000000000000000000000000000000000000009393999339333333000000000000000000000000000000000000000000000000
00000000eeffff000000000000000000000000000000000000000000000000003333333333333333000000000000000000000000000000000000000000000000
00000000e01110000000000000000000000000000000000000000000000000003333333333333333000000000000000000000000000000000000000000000000
00000000002020000000000000000000000000000000000000000000000000009993939399933333000000000000000000000000000000000000000000000000
00000000110000111100001111000011110000111100001100000000000000003933999393333333000000000000000000000000000000000000000000000000
00000000010110100101101001011010010110100101101000000000000000003933939399333333000000000000000000000000000000000000000000000000
00000000011111100111111001111110011111100111111000000000000000003933939399933333000000000000000000000000000000000000000000000000
0000000001a11a1001a11a100111111001a11a1001a11a1000000000000000003333333333333333000000000000000000000000000000000000000000000000
0000000011a11a1111111111111111111111111111a11a1100000000000000009993993399939993000000000000000000000000000000000000000000000000
00000000111111111111111111111111111111111111111100000000000000003933939393339333000000000000000000000000000000000000000000000000
00000000111111111111111111111111111111111111111100000000000000003933993399339933000000000000000000000000000000000000000000000000
00000000011001100110011001100110011001100110011000000000000000003933939399939993000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000
__gff__
0000010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
